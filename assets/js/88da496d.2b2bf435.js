"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[1476],{3905:(e,t,n)=>{n.d(t,{Zo:()=>l,kt:()=>g});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var m=r.createContext({}),p=function(e){var t=r.useContext(m),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},l=function(e){var t=p(e.components);return r.createElement(m.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},c=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,m=e.parentName,l=i(e,["components","mdxType","originalType","parentName"]),c=p(n),g=a,d=c["".concat(m,".").concat(g)]||c[g]||u[g]||o;return n?r.createElement(d,s(s({ref:t},l),{},{components:n})):r.createElement(d,s({ref:t},l))}));function g(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,s=new Array(o);s[0]=c;var i={};for(var m in t)hasOwnProperty.call(t,m)&&(i[m]=t[m]);i.originalType=e,i.mdxType="string"==typeof e?e:a,s[1]=i;for(var p=2;p<o;p++)s[p]=n[p];return r.createElement.apply(null,s)}return r.createElement.apply(null,n)}c.displayName="MDXCreateElement"},4191:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>m,contentTitle:()=>s,default:()=>u,frontMatter:()=>o,metadata:()=>i,toc:()=>p});var r=n(7462),a=(n(7294),n(3905));const o={id:"mattermost-integration_guide",title:"Mattermost Integration",sidebar_position:7},s=void 0,i={unversionedId:"guides/mattermost-integration_guide",id:"guides/mattermost-integration_guide",title:"Mattermost Integration",description:"Overview",source:"@site/docs/guides/mattermost-integration_guide.md",sourceDirName:"guides",slug:"/guides/mattermost-integration_guide",permalink:"/argo-messaging/docs/guides/mattermost-integration_guide",draft:!1,tags:[],version:"current",sidebarPosition:7,frontMatter:{id:"mattermost-integration_guide",title:"Mattermost Integration",sidebar_position:7},sidebar:"tutorialSidebar",previous:{title:"Metrics Guide",permalink:"/argo-messaging/docs/guides/guide_metrics"},next:{title:"API Calls",permalink:"/argo-messaging/docs/category/api-calls"}},m={},p=[{value:"Overview",id:"overview",level:2},{value:"Mattermost Configuration",id:"mattermost-configuration",level:4},{value:"Subscription Configuration",id:"subscription-configuration",level:4},{value:"Reformat Messages Example",id:"reformat-messages-example",level:2}],l={toc:p};function u(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,r.Z)({},l,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"overview"},"Overview"),(0,a.kt)("p",null,"Push enabled subscriptions provide us with the functionality to\nforward messages to mattermost channels via mattermost webhooks."),(0,a.kt)("h4",{id:"mattermost-configuration"},"Mattermost Configuration"),(0,a.kt)("p",null,"Refer to this guide on how to set up your mattermost webhook.\n",(0,a.kt)("a",{parentName:"p",href:"https://mattermost.com/blog/mattermost-integrations-incoming-webhooks/"},"https://mattermost.com/blog/mattermost-integrations-incoming-webhooks/")),(0,a.kt)("h4",{id:"subscription-configuration"},"Subscription Configuration"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "topic": "projects/example/topics/alarms-reformat-mattermost-topic",\n  "pushConfig": {\n    "type": "mattermost",\n    "maxMessages": 1,\n    "retryPolicy": {\n      "type": "linear",\n      "period": 3000\n    },\n    "mattermostUrl": "https://example.com/hooks/z5xjq7hzn7yobnjhthrh4q6oxw",\n    "mattermostUsername": "bot argo",\n    "mattermostChannel": "monitoring-alarms",\n    "base64Decode": true\n  }\n}\n')),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("inlineCode",{parentName:"p"},"mattermostUrl"),": Is the webhook url that will be generated through\nthe integrations tab of the mattermost UI.")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("inlineCode",{parentName:"p"},"mattermostUsername"),": Is the username that will be displayed alongside\nthe forwarded messages.")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("inlineCode",{parentName:"p"},"mattermostChannel"),": Is the channel that the messages will be forwarded to.")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("inlineCode",{parentName:"p"},"base64Decode"),": Messages in AMS should be base64 encoded.This flag allows a subscription\nto know if the the messages should be first decoded before being pushed\nto the remote destination.\nRefer to the following guides to better understand push enabled subscriptions\nand how to use them."))),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"http://argoeu.github.io/argo-messaging/openapi/explore#/Subscriptions/put_projects__PROJECT__subscriptions__SUBSCRIPTION_"},"Swagger Create Subscription")),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"http://argoeu.github.io/argo-messaging/docs/api_advanced/api_subscriptions#push-enabled-subscriptions"},"Push Enabled Subscriptions")),(0,a.kt)("h2",{id:"reformat-messages-example"},"Reformat Messages Example"),(0,a.kt)("p",null,"In some cases, a topic that has some raw messages, but we first\nwant to process them and reformat them, before pushing to mattermost,\nor reusing them for any other activity.\nIn order to achieve this we need to consume from the topic's subscription\nand republish them to another topic after the messages have been processes.\nWe then attach a push enabled subscription to the topic with the\nreformatted messages."),(0,a.kt)("p",null,"The following snipper shows this kind of functionality."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"NOTE:")," Implement your own ",(0,a.kt)("inlineCode",{parentName:"p"},"format_message()")," function to\ntransform messages to the desired format. The function accepts the\noriginal message decoded as input, and returns the formatted string."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-python"},'\n    # set up the ams client\n    ams_host = "{0}:{1}".format(args.host, str(args.port))\n    LOGGER.info("Setting up AMS client for host {0} and project: {1}".format(ams_host, args.project))\n    ams = ArgoMessagingService(endpoint=ams_host, project=args.project, token=args.token)\n\n    while True:\n        try:\n            # consume alerts\n            consumed_messages = ams.pull_sub(sub=args.sub, return_immediately=True, verify=args.verify)\n            if len(consumed_messages) == 0:\n                time.sleep(args.interval)\n                continue\n            payload = consumed_messages[0][1].get_data()\n            ack_id = consumed_messages[0][0]\n\n            # if we can\'t parse the message body we should ack the message and move to the next\n            try:\n                payload = json.loads(payload)\n                LOGGER.info("Examining new message {0} . . .".format(ack_id))\n\n                # skip messages that don\'t have a type of \'endpoint\' or \'group\'\n                if "type" not in payload or (payload["type"] != \'endpoint\' and payload["type"] != \'group\'):\n                    LOGGER.info("Skipping message {0} with wrong payload . . .".format(ack_id))\n                    try:\n                        ams.ack_sub(sub=args.sub, ids=[ack_id], verify=args.verify)\n                        continue\n                    except AmsException as e:\n                        LOGGER.error("Could not skip message {0}.{1}".format(ack_id, str(e)))\n                        continue\n            except Exception as e:\n                LOGGER.error("Cannot parse payload for message {0}.{1}.Skipping . . .".format(ack_id, str(e)))\n                try:\n                    ams.ack_sub(sub=args.sub, ids=[ack_id], verify=args.verify)\n                    continue\n                except AmsException as e:\n                    LOGGER.error("Could not skip message {0}.{1}".format(ack_id, str(e)))\n                    continue\n\n            # format and publish the new message\n            formatted_message = format_message(payload)\n            try:\n                ams.publish(topic=args.topic, msg=[AmsMessage(data=formatted_message)], verify=args.verify)\n            except AmsException as e:\n                LOGGER.error("Could not publish to topic.{0}".format(str(e)))\n                continue\n\n            # ack the original alert\n            try:\n                ams.ack_sub(sub=args.sub, ids=[ack_id], verify=args.verify)\n            except AmsException as e:\n                LOGGER.error("Could not ack original alert {0}.{1}".format(ack_id, str(e)))\n        except AmsException as e:\n            LOGGER.error("Cannot pull from subscription.{0}".format(str(e)))\n\n        time.sleep(args.interval)\n')))}u.isMDXComponent=!0}}]);